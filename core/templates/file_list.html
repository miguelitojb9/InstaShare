{% extends 'base.html' %} {% load static %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-file-archive"></i> My Files</h1>
  <div>
    <a href="{% url 'upload' %}" class="btn btn-primary">
      <i class="fas fa-upload"></i> Upload New File
    </a>
    <a class="btn btn-warning compress-btn" id="zipButton">
      <i class="fas fa"></i> Zip All File
    </a>
  </div>
</div>

{% if files %}
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Size</th>
        <th>Status</th>
        <th>Uploaded</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for file in files %}
      <tr>
        <td>{{ file.display_name }}</td>
        <td>{{ file.get_file_size_mb|floatformat:2 }} MB</td>
        <td>
          <span
            class="badge {% if file.status == 'completed' %}bg-success {% elif file.status == 'processing' %}bg-warning {% elif file.status == 'failed' %}bg-danger {% else %}bg-secondary{% endif %}"
          >
            {{ file.get_status_display }}
          </span>
        </td>
        <td>{{ file.uploaded_at|date:"M d, Y H:i" }}</td>
        <td>
          <a
            href="{% url 'rename' file.id %}"
            class="btn btn-sm btn-outline-primary"
          >
            <i class="fas fa-edit"></i> Rename
          </a>
          {% if file.status == 'completed' %}
          <a
            href="{% url 'download' file.id %}"
            class="btn btn-sm btn-outline-success"
          >
            <i class="fas fa-download"></i> Download
          </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="text-center py-5">
  <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
  <h3 class="text-muted">No files uploaded yet</h3>
  <p class="text-muted">Get started by uploading your first file</p>
  <a href="{% url 'upload' %}" class="btn btn-primary mt-2">
    <i class="fas fa-upload"></i> Upload File
  </a>
</div>
{% endif %} {% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const zipButton = document.querySelector(".btn-warning");
    $("#zipButton").on("click", function () {
      // Mostrar confirmación antes de ejecutar
      Swal.fire({
        title: "¿Ejecutar proceso ZIP?",
        text: "Esta acción procesará y comprimirá los archivos.",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sí, ejecutar",
        cancelButtonText: "Cancelar",
      }).then((result) => {
        if (result.isConfirmed) {
          ejecutarProcesoZIP();
        }
      });
    });

    function ejecutarProcesoZIP() {
      const $button = $("#zipButton");
      const originalText = $button.text();

      $button
        .prop("disabled", true)
        .html(
          '<span class="spinner-border spinner-border-sm"></span> Procesando...'
        );

      $.ajax({
        url: "{% url 'ejecutar_proceso_zip' %}",
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        dataType: "json",
      })
        .done(function (data) {
          if (data.success) {
            Swal.fire({
              icon: "success",
              title: "Completado",
              text: data.message,
              timer: 2000,
              showConfirmButton: false,
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message || data.error,
            });
          }
        })
        .fail(function (xhr, status, error) {
          Swal.fire({
            icon: "error",
            title: "Error de conexión",
            text: "No se pudo completar la operación",
          });
        })
        .always(function () {
          $button.prop("disabled", false).html(originalText);
        });
    }
  });
</script>
{% endblock %}
